name: ü§ñ Auto SEO + IndexNow + Cloudflare Deploy

on:
  schedule:
    - cron: "0 */12 * * *" # ‚è∞ Every 12 hours
  workflow_dispatch:

jobs:
  auto-seo:
    runs-on: ubuntu-latest

    steps:
      # ----------------------------------------
      # 1Ô∏è‚É£ Checkout Repo
      # ----------------------------------------
      - name: üßæ Checkout Repository
        uses: actions/checkout@v4

      # ----------------------------------------
      # 2Ô∏è‚É£ Setup Node.js + Cache
      # ----------------------------------------
      - name: ‚öôÔ∏è Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      # ----------------------------------------
      # 3Ô∏è‚É£ Install Dependencies
      # ----------------------------------------
      - name: üì¶ Install Dependencies
        run: npm ci

      # ----------------------------------------
      # 4Ô∏è‚É£ Ensure IndexNow Key
      # ----------------------------------------
      - name: üîë Ensure IndexNow Key
        run: |
          mkdir -p ./public || true
          if [ ! -f indexnow-key.txt ]; then
            echo "‚öôÔ∏è Generating new indexnow-key.txt..."
            KEY=$(openssl rand -hex 16)
            echo "$KEY" > indexnow-key.txt
            echo "‚úÖ New IndexNow key generated: $KEY"
          else
            echo "‚úÖ Existing indexnow-key.txt found"
          fi

      # ----------------------------------------
      # 5Ô∏è‚É£ Generate Main Sitemap + SEO Meta
      # ----------------------------------------
      - name: üåê Generate Main SEO Files
        env:
          SHEET_KEY: ${{ secrets.GOOGLE_SHEET_API_KEY }}
        run: |
          echo "üó∫Ô∏è Running generate-sitemap.mjs..."
          node generate-sitemap.mjs || echo "‚ö†Ô∏è Skipped main sitemap"

      # ----------------------------------------
      # 6Ô∏è‚É£ Generate Actress Pages + Sitemap
      # ----------------------------------------
      - name: üé¨ Generate Actress Pages + SEO Data
        continue-on-error: true
        run: |
          echo "üé• Running generate-actresses.mjs..."
          node generate-actresses.mjs || echo "‚ö†Ô∏è Skipped actresses generation"

      # ----------------------------------------
      # 7Ô∏è‚É£ Generate Sitemap Index + Update Log
      # ----------------------------------------
      - name: üóÇÔ∏è Build Sitemap Index + Update Log
        run: |
          echo "üóÇÔ∏è Creating sitemap-index.xml..."
          node sitemap-index.mjs || echo "‚ö†Ô∏è Sitemap index skipped"
          echo "üßæ Updating run log..."
          node update-log.mjs || echo "‚ö†Ô∏è Log update skipped"

      # ----------------------------------------
      # 8Ô∏è‚É£ Commit and Push Changes
      # ----------------------------------------
      - name: üíæ Commit SEO Updates
        id: commit
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add -f sitemap.xml sitemap.xml.gz robots.txt seo-meta.json \
            sitemap-actors.xml seo-meta-actors.json sitemap-index.xml \
            actors/ indexnow-key.txt _headers logs/ || true

          if git diff --cached --quiet; then
            echo "‚úÖ No file changes to commit."
            echo "files_committed=false" >> $GITHUB_OUTPUT
          else
            echo "üìù Files changed:"
            git status -s
            TIMESTAMP=$(date -u +%Y-%m-%dT%H:%M:%SZ)
            git commit -m "ü§ñ Auto SEO + IndexNow update: ${TIMESTAMP}"
            git push origin main --no-verify
            echo "‚úÖ Changes committed & pushed."
            echo "files_committed=true" >> $GITHUB_OUTPUT
          fi

      # ----------------------------------------
      # 9Ô∏è‚É£ Trigger Cloudflare Pages Deploy
      # ----------------------------------------
      - name: üöÄ Deploy to Cloudflare Pages
        if: success() && steps.commit.outputs.files_committed == 'true'
        env:
          CF_ACCOUNT_ID: ${{ secrets.CF_ACCOUNT_ID }}
          CF_PROJECT_NAME: ${{ secrets.CF_PROJECT_NAME }}
          CF_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
        run: |
          echo "üöÄ Deploying new build to Cloudflare..."
          curl -X POST "https://api.cloudflare.com/client/v4/accounts/${CF_ACCOUNT_ID}/pages/projects/${CF_PROJECT_NAME}/deployments" \
            -H "Authorization: Bearer ${CF_API_TOKEN}" \
            -H "Content-Type: application/json" \
            --data '{"branch":"main"}' \
            --fail --silent --show-error || echo "‚ö†Ô∏è Cloudflare deploy skipped"

      # ----------------------------------------
      # üîü Purge Cloudflare Cache
      # ----------------------------------------
      - name: üßπ Purge Cloudflare Cache
        if: success() && steps.commit.outputs.files_committed == 'true'
        env:
          CF_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CF_ZONE_ID: ${{ secrets.CF_ZONE_ID }}
        run: |
          echo "üßπ Clearing Cloudflare cache..."
          curl -X POST "https://api.cloudflare.com/client/v4/zones/${CF_ZONE_ID}/purge_cache" \
            -H "Authorization: Bearer ${CF_API_TOKEN}" \
            -H "Content-Type: application/json" \
            --data '{"files":["https://dareloom.fun/sitemap.xml","https://dareloom.fun/sitemap-actors.xml","https://dareloom.fun/sitemap-index.xml","https://dareloom.fun/robots.txt"]}'

      # ----------------------------------------
      # 1Ô∏è‚É£1Ô∏è‚É£ Notify Search Engines (via ping-search.mjs)
      # ----------------------------------------
      - name: üîî Notify Search Engines
        if: success() && steps.commit.outputs.files_committed == 'true'
        continue-on-error: true
        run: |
          echo "üîî Running ping-search.mjs..."
          node ping-search.mjs || echo "‚ö†Ô∏è Ping script failed but continuing"

      # ----------------------------------------
      # 1Ô∏è‚É£2Ô∏è‚É£ Confirmation Log
      # ----------------------------------------
      - name: ‚úÖ Final Confirmation
        run: echo "üéâ Auto SEO + Sitemap + IndexNow workflow completed successfully!"
