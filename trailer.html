<!doctype html>
<html lang="en">  
<head>  
  <meta charset="utf-8" />  
  <meta name="viewport" content="width=device-width,initial-scale=1" />  
  <title id="pageTitle">Trailer & Watch Details</title>  
  <link rel="stylesheet" href="/style.css?v=20251021" />  
  <style>
    /* Inline styles for trailer.html specific layout */
    :root {
      --primary-color: #ff4b91;
      --secondary-color: #1e90ff;
      --bg-color: #000;
      --card-bg: #111;
      --text-color: #fff;
    }
    body {
      margin: 0;
      background: var(--bg-color);
      color: var(--text-color);
      font-family: 'Poppins', sans-serif;
    }
    .wrap {
      max-width: 900px;
      margin: 0 auto;
      padding: 20px;
    }
    
    /* üõë FIX 1: Video Player Aspect Ratio for 16:9 (using padding-top hack) */
    .video-player-container {
      position: relative;
      width: 100%; 
      padding-top: 56.25%; /* 9 / 16 = 0.5625 (16:9 ratio) */
      height: 0; /* Height is now controlled by padding-top */
      background: #000;
      margin-bottom: 20px;
      overflow: hidden; 
    }
    
    .video-player-container iframe, 
    .video-player-container div#playerEmbed {
      /* CRITICAL: Make the player fill the 16:9 container */
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      border: none;
      /* Ensure fallback text is centered */
      display: flex; 
      align-items: center;
      justify-content: center;
      text-align: center;
    }

    /* Buttons Layout */
    .action-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      margin: 20px 0;
      justify-content: center;
    }
    .action-buttons button, .action-buttons a {
      flex: 1 1 200px;
      padding: 12px;
      border-radius: 8px;
      border: none;
      font-weight: 700;
      cursor: pointer;
      text-align: center;
      text-decoration: none;
      transition: background-color 0.2s;
      font-size: 1rem;
    }
    /* Button Colors */
    #watchButton {
      background: var(--primary-color);
      color: #fff;
    }
    /* Note: Streamtape and Telegram button styles are now redundant but kept for style consistency */
    #streamtapeButton {
      background: #0088ff; 
      color: #fff;
    }
    #telegramButton {
      background: #2aabee; 
      color: #fff;
    }
    #description {
      color: #aaa;
      margin-top: 10px;
    }
    #tagsContainer {
      margin-top: 15px;
    }
    .tag-btn {
        background: #333;
        color: #aaa;
        border: none;
        padding: 5px 10px;
        margin-right: 5px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.9rem;
        display: inline-block;
    }
    /* Mobile adjustments */
    @media (max-width: 600px) {
        .action-buttons button, .action-buttons a {
            flex: 1 1 100%; /* Stack buttons on small screens */
        }
    }
  </style>
</head>  

<body>  
    <div class="wrap">
        <h1 id="videoTitle">Loading...</h1>
        <div class="video-player-container">
            <div id="playerEmbed">
                </div>
        </div>

        <div class="action-buttons">
            </div>

        <h2>Description and Tags</h2>
        <p id="description">Loading description...</p>
        <div id="tagsContainer"></div>

        <a href="/" style="display:block; text-align:center; margin-top:30px; color:var(--secondary-color);">‚Üê Back to Homepage</a>
    </div>

    <script>
        // --- Helper Functions (From script.js) ---
        const qs = sel => document.querySelector(sel);
        
        function getParam(name) {
            return new URLSearchParams(window.location.search).get(name);
        }
        
        function extractYouTubeID(url) {
            if (!url) return null;
            const m = url.match(/(?:v=|youtu.be\/|shorts\/|embed\/)([0-9A-Za-z_-]{11})/);
            return m ? m[1] : null;
        }
        
        // üõë FINAL EMBED LOGIC: Supports YouTube, Streamtape, and Direct URLs
        function toEmbedUrl(url){
            if (!url) return '';
            url = url.trim();
            const y = extractYouTubeID(url);
            
            // 1. YouTube embed (Fixed URL parameters)
            if (y) return `https://www.youtube.com/embed/${y}?autoplay=0&rel=0`; 
            
            // 2. Streamtape embed 
            if (url.includes('streamtape.com') && url.includes('/v/')){
                const id = url.split('/v/')[1]?.split('/')[0];
                if (id) return `https://streamtape.com/e/${id}/`;
            }
            
            // 3. Direct URL embed (Any other HTTP/HTTPS link)
            // Note: Mixdrop/Streamwish links are NOT embeddable here, only direct MP4s or supported hosts.
            if (url.startsWith('http')) return url;
            
            return '';
        }
        
        // Simplified: Since you are using /go.html as an ad-gate/redirect, 
        // the target URL should just be the original watch link.
        function openWatchPage(targetUrl){
            if (!targetUrl) return;
            // Target URL is the original full link (could be multiple links)
            const redirectPage = `/go.html?target=${encodeURIComponent(targetUrl)}`;  
            window.location.href = redirectPage; 
        }

        function renderTagsForItem(it){
            if (!it.category || !it.category.trim()) return '';
            const parts = it.category.split(',').map(p => p.trim()).filter(Boolean);
            return parts.map(p => `<span class="tag-btn" data-tag="${p}">#${p}</span>`).join(' ');
        }

        // --- Main Trailer Page Logic ---
        async function loadTrailerPage() {
            const id = getParam('id');
            // CRITICAL: Loads data saved from the homepage's script.js
            const allItems = JSON.parse(localStorage.getItem('dareloom_items') || '[]');
            const item = allItems.find(i => i.id === id);

            if (!id || !item) {
                qs('#videoTitle').textContent = 'Error: Video details not found.';
                qs('#description').textContent = 'Please return to the homepage and select a video.';
                return;
            }

            // 1. Set details
            document.title = item.title + " | Details";
            qs('#videoTitle').textContent = item.title;
            
            // 2. Set Description 
            qs('#description').textContent = item.description || 'No description available.';

            // 3. Embed Player: Prioritize Trailer, then Watch Link
            // Only embed if it's a direct embed link (YouTube, Streamtape, direct MP4)
            const embedUrl = toEmbedUrl(item.trailer || item.watch);
            
            if (embedUrl) {
                qs('#playerEmbed').innerHTML = `
                    <iframe src="${embedUrl}" 
                            allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture"
                            allowfullscreen>
                    </iframe>
                `;
            } else {
                 // Fallback if no embeddable trailer or video is available
                qs('#playerEmbed').innerHTML = '<div style="color: #fff; font-weight: bold; font-size: 1.1rem; padding: 20px;">Trailer/Video cannot be embedded here. Please use the "Open Player" button below.</div>';
            }

            // 4. Render Buttons (Only the Open Player button)
            const buttonsContainer = qs('.action-buttons');
            buttonsContainer.innerHTML = ''; // Clear any existing content
            
            if (item.watch) {
                // Open Player Button: Uses the original watch link which goes through the ad-gate (/go.html)
                buttonsContainer.innerHTML += `<button id="watchButton" onclick="openWatchPage('${item.watch}')">Open Player</button>`;
            }
            
            if (!item.watch) {
                buttonsContainer.innerHTML = '<p style="text-align:center; width:100%; color:#aaa;">No watch link available for this title.</p>';
            }


            // 5. Render Tags
            qs('#tagsContainer').innerHTML = renderTagsForItem(item);
        }

        // Start the loader
        loadTrailerPage();
    </script>
</body>
</html>
