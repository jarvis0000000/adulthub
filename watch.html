<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Now Watching - Dareloom Hub</title>
<style>
/* CSS is mostly unchanged */
:root {
    --primary: #e91e63; /* Pink */
    --background: #000;
    --text-color: #fff;
    --muted-color: #aaa;
}
body,html{
  margin:0;padding:0;height:100%;
  background:var(--background);color:var(--text-color);font-family:sans-serif;
  display:flex;flex-direction:column;align-items:center;
}
header{
  background:#111;padding:12px 0;text-align:center;
  font-size:22px;font-weight:bold;width:100%;
  box-shadow:0 2px 6px rgba(0,0,0,0.5);
  z-index: 10;
}
/* NEW: Video Wrap for aspect ratio and error state */
#videoWrap {
    width: 100%;
    min-height: 300px; 
    display: flex;
    justify-content: center;
    align-items: center;
    flex-direction: column;
}
iframe{
  width:100%;
  /* Changed from fixed height to max-height with aspect-ratio */
  max-height: 75vh; 
  aspect-ratio: 16 / 9; 
  min-height: 250px;
  border:none;
  margin-top:10px;
}
.ad-box{
  margin:8px 0;
  width:100%;text-align:center;
  /* CLS Fix: Ensure space is reserved for the 728x90 ad */
  min-height: 90px;
  display: flex;
  justify-content: center;
  align-items: center;
}
.btn{
  /* Base Pink button */
  background:var(--primary);
  color:#fff;
  border:none;
  padding:12px 20px; 
  border-radius:8px;
  cursor:pointer;
  font-weight:bold;
  margin:8px 10px; 
  transition: background 0.3s, transform 0.1s;
  box-shadow: 0 4px 6px rgba(0,0,0,0.3); 
  text-decoration: none; 
  display: inline-flex;
  align-items: center;
  gap: 8px;
  font-size: 16px;
}
.btn:hover {
    background: #c2185b;
    transform: translateY(-1px); 
}
footer{text-align:center;padding:10px;color:var(--muted-color);}

/* NEW: Ad Block Warning Styling */
#adblock-warning-overlay {
  display:none; 
  position:fixed; 
  top:0; 
  left:0; 
  width:100%; 
  height:100%; 
  background:rgba(0,0,0,0.95); 
  color:white; 
  text-align:center; 
  z-index:99999; 
  backdrop-filter: blur(5px); 
  justify-content:center; 
  align-items:center; 
  flex-direction:column; 
  padding:20px;
  box-sizing: border-box;
}

/* Main Content Wrapper for visibility control */
#main-content-wrapper {
    display: none; 
    flex-direction: column;
    align-items: center;
    width: 95%;
    max-width: 900px;
    flex-grow: 1;
}

/* User Message Box */
#user-message {
    background: #333;
    color: #fff;
    padding: 10px 20px;
    border-radius: 8px;
    width: 100%;
    margin-top: 10px;
    text-align: center;
    font-size: 16px;
    font-weight: 500;
}

#controls-container {
    display: flex;
    justify-content: center;
    width: 100%;
    flex-wrap: wrap;
    margin-top: 10px;
}

/* Custom Button Colors for better design */
.btn-telegram { background: #0088cc !important; }
.btn-telegram:hover { background: #0077b3 !important; }

.btn-mixdrop { background: #ff4500 !important; } /* OrangeRed */
.btn-mixdrop:hover { background: #cc3700 !important; }

.btn-streamwish { background: #1e88e5 !important; } /* Blue */
.btn-streamwish:hover { background: #1565c0 !important; }

.btn-streamtape { background: #6a0dad !important; } /* Purple */
.btn-streamtape:hover { background: #5a0a99 !important; }

.btn-mega { background: #007bff !important; }
.btn-mega:hover { background: #0069d9 !important; }

</style>
</head>

<body>
<header>üé• Dareloom Hub</header>

<div id="adblock-warning-overlay" role="alert" aria-live="assertive">
    <h1 style="color:#FFD700; font-size: 2.2rem; margin-top:0;">üö´ Ad Blocker Detected!</h1>
    <p style="font-size:18px; margin-top:20px; max-width:600px;">
        Humein maaf kijiye, hum aapko video nahi dikha sakte jab tak aap apna **Ad Blocker** disable nahi karte.
        Kripya Ad Blocker band karein aur page ko **refresh** karein.
    </p>
</div>

<div id="main-content-wrapper">
    <div id="user-message">
        üéâ **Enjoy watching!** For a better experience, click **full screen** to avoid in-player ads.
    </div>
    
    <div id="videoWrap"></div>

    <div class="ad-box">
      <script type="text/javascript">
        atOptions = {
          'key' : 'd1be46ed95d3e2db572824c531da5082',
          'format' : 'iframe',
          'height' : 90,
          'width' : 728,
          'params' : {}
        };
      </script>
      <script type="text/javascript" src="//www.highperformanceformat.com/d1be46ed95d3e2db572824c531da5082/invoke.js"></script>
    </div>

    <div id="controls-container">
        </div>
</div>

<footer>¬© Dareloom Hub</footer>

<script>
    // üõë CTR OPTIMIZATION: Aggressive Timing
    const AD_POP = "//bulletinsituatedelectronics.com/24/e4/33/24e43300238cf9b86a05c918e6b00561.js";
    const POP_COOLDOWN_MS = 4000; 
    const POP_DELAY_MS = 500;     
    let lastPop = 0;
    let isAdBlockerActive = false; 

    function openAdsterraPop(){
        if (isAdBlockerActive) return; 
        const now = Date.now();
        if (now - lastPop < POP_COOLDOWN_MS) return;
        lastPop = now;
        setTimeout(() => {
            try{
                const s = document.createElement('script');
                s.src = AD_POP;
                s.async = true;
                document.body.appendChild(s);
                setTimeout(()=>{ try{s.remove();}catch(e){} }, 5000); 
            }catch(e){ console.warn("Ad pop failed", e); }
        }, POP_DELAY_MS);
    }
</script>


<script>
// ------------- AD BLOCKER LOGIC -------------
function showAdBlockerWarning(){
    isAdBlockerActive = true;
    const warning = document.getElementById('adblock-warning-overlay');
    const content = document.getElementById('main-content-wrapper');
    if (warning) warning.style.display = 'flex';
    if (content) content.style.display = 'none';
}

function showContent(){
    isAdBlockerActive = false;
    const warning = document.getElementById('adblock-warning-overlay');
    const content = document.getElementById('main-content-wrapper');
    if (warning) warning.style.display = 'none';
    if (content) content.style.display = 'flex'; 
}

function checkAdBlocker(){
    return new Promise(resolve => {
        const dummyAd = document.createElement('div');
        dummyAd.className = 'pub_300x250 pub_dummy_ad ads adblock_detected';
        dummyAd.style.width = '1px';
        dummyAd.style.height = '1px';
        dummyAd.style.position = 'absolute';
        dummyAd.style.left = '-1000px';
        document.body.appendChild(dummyAd);
        setTimeout(() => {
            if (dummyAd.offsetHeight === 0 || dummyAd.offsetParent === null || window.getComputedStyle(dummyAd).getPropertyValue('display') === 'none') {
                resolve(true); 
            } else {
                resolve(false); 
            }
            dummyAd.remove();
        }, 300);
    });
}
// ------------- VIDEO LOAD LOGIC (FINAL UPDATED PRIORITY) -------------
/**
 * üí• EMBED FIX: Streamwish ‡§î‡§∞ Mixdrop ‡§ï‡•á ‡§∏‡§≠‡•Ä ‡§°‡•ã‡§Æ‡•á‡§® ‡§ï‡•ã ‡§∏‡§™‡•ã‡§∞‡•ç‡§ü ‡§ï‡§∞‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§Ö‡§™‡§°‡•á‡§ü ‡§ï‡§ø‡§Ø‡§æ ‡§ó‡§Ø‡§æ‡•§
 * @param {string} url 
 * @returns {string} The embeddable URL for the given host
 */
function getEmbedUrl(url) {
    if (!url) return '';
    
    let finalEmbedUrl = url.trim();

    // 1. Streamwish Fix (P1): ‡§ï‡§ø‡§∏‡•Ä ‡§≠‡•Ä ‡§°‡•ã‡§Æ‡•á‡§® ‡§ï‡•á ‡§≤‡§ø‡§è ID ‡§®‡§ø‡§ï‡§æ‡§≤‡§ï‡§∞ streamwish.to/e/ID ‡§¨‡§®‡§æ‡§§‡§æ ‡§π‡•à
    if (finalEmbedUrl.includes("streamwish.") || finalEmbedUrl.includes("dumbalag.com") || finalEmbedUrl.includes("hglink.to")) {
        // Regex to find ID at the end, regardless of domain (e.g., hglink.to/1kmdiikkt0to)
        let idMatch = finalEmbedUrl.match(/\/([0-9A-Za-z_-]{12,})$/); 
        
        // Handle streamwish.com/file/ID format
        if (!idMatch) {
            idMatch = finalEmbedUrl.match(/\/file\/([0-9A-Za-z_-]{12,})/);
        }
        
        // If an ID is found, construct the reliable embed URL
        if (idMatch && idMatch[1]) {
            return `https://streamwish.to/e/${idMatch[1]}`;
        }
    }

    // 2. MixDrop Fix (P2): ‡§ï‡§ø‡§∏‡•Ä ‡§≠‡•Ä ‡§°‡•ã‡§Æ‡•á‡§® ‡§ï‡•á ‡§≤‡§ø‡§è ID ‡§®‡§ø‡§ï‡§æ‡§≤‡§ï‡§∞ mixdrop.co/e/ID ‡§¨‡§®‡§æ‡§§‡§æ ‡§π‡•à
    if (finalEmbedUrl.includes("mixdrop.") || finalEmbedUrl.includes("mdy48tn97.com") || finalEmbedUrl.includes("/f/")) {
        // Regex to find ID at the end or after /f/
        let idMatch = finalEmbedUrl.match(/\/([0-9A-Za-z_-]{12,})$/); 
        
        // Handle /f/ID format explicitly
        if (!idMatch) {
            idMatch = finalEmbedUrl.match(/\/f\/([0-9A-Za-z_-]{12,})/);
        }
        
        // If an ID is found, construct the reliable embed URL
        if (idMatch && idMatch[1]) {
            return `https://mixdrop.co/e/${idMatch[1]}`; // Using mixdrop.co for reliable embed
        }
    }
    
    // 3. Streamtape (P3)
    if (finalEmbedUrl.includes("streamtape.com/v/")){
        const m = finalEmbedUrl.match(/\/v\/([0-9A-Za-z_-]+)\//);
        if (m && m[1]) return `https://streamtape.com/e/${m[1]}/`;
    }

    // 4. MEGA Link (Not embeddable)
    if (finalEmbedUrl.includes("mega.nz")) {
        return 'MEGA'; 
    }
    
    // 5. Google Drive (Only for /view to /preview conversion)
    if (finalEmbedUrl.includes("drive.google.com") && finalEmbedUrl.includes("/view")) {
        return finalEmbedUrl.replace("/view", "/preview");
    }

    // 6. Generic Link
    return finalEmbedUrl;
}

async function loadVideo(){
    // 1. Check Ad Blocker
    const adBlockActive = await checkAdBlocker();
    if (adBlockActive) {
        showAdBlockerWarning();
        return; 
    }
    showContent();
    
    // 2. Pop-under Ad on successful load
    openAdsterraPop();

    // 3. Video URL Parsing and rendering
    const params = new URLSearchParams(window.location.search);
    let raw = params.get("url");
    const videoWrap = document.getElementById("videoWrap");
    const controlsContainer = document.getElementById("controls-container");
    
    // Clear existing controls
    controlsContainer.innerHTML = '';
    
    if(raw){
        const fullUrl = decodeURIComponent(raw).trim();
        const links = fullUrl.split(',').map(l => l.trim()).filter(Boolean);
        
        let telegramLink = '';
        const hostLinks = {
            'mixdrop': { url: '', embedUrl: '' },
            'streamwish': { url: '', embedUrl: '' },
            'streamtape': { url: '', embedUrl: '' },
            'mega': { url: '', embedUrl: '' },
            'other': { url: '', embedUrl: '' },
        };
        
        // Parse all links and categorize them
        for(const link of links){
            const normalizedLink = link.toLowerCase(); // Use lower case for checking host

            if (normalizedLink.includes("t.me") || normalizedLink.includes("telegram.me")) {
                telegramLink = link;
            } else if (normalizedLink.includes("mixdrop.") || normalizedLink.includes("/f/") || normalizedLink.includes("mdy")) {
                if (!hostLinks.mixdrop.url) { 
                    hostLinks.mixdrop.url = link;
                    // *** USE getEmbedUrl HERE ***
                    hostLinks.mixdrop.embedUrl = getEmbedUrl(link);
                }
            } else if (normalizedLink.includes("streamwish.") || normalizedLink.includes("dumbalag.com") || normalizedLink.includes("hglink.to")) {
                if (!hostLinks.streamwish.url) {
                    hostLinks.streamwish.url = link;
                    // *** USE getEmbedUrl HERE ***
                    hostLinks.streamwish.embedUrl = getEmbedUrl(link);
                }
            } else if (normalizedLink.includes("streamtape.com/")) {
                if (!hostLinks.streamtape.url) {
                    hostLinks.streamtape.url = link;
                    // *** USE getEmbedUrl HERE ***
                    hostLinks.streamtape.embedUrl = getEmbedUrl(link);
                }
            } else if (normalizedLink.includes("mega.nz")) {
                if (!hostLinks.mega.url) {
                    hostLinks.mega.url = link;
                    // *** USE getEmbedUrl HERE ***
                    hostLinks.mega.embedUrl = getEmbedUrl(link);
                }
            } else {
                if (!hostLinks.other.url) {
                    hostLinks.other.url = link;
                    // *** USE getEmbedUrl HERE ***
                    hostLinks.other.embedUrl = getEmbedUrl(link);
                }
            }
        }
        
        let embedLink = null;
        let isMega = false;
        
        // **NEW PRIORITY LOGIC:** 1. Streamwish > 2. MixDrop > 3. Streamtape > Other
        // IMPORTANT: We check for a valid embed URL that is NOT 'MEGA'
        if (hostLinks.streamwish.embedUrl && hostLinks.streamwish.embedUrl !== 'MEGA' && !hostLinks.streamwish.embedUrl.startsWith('http') && hostLinks.streamwish.embedUrl.includes('/e/')) {
            embedLink = hostLinks.streamwish.embedUrl;
        } else if (hostLinks.mixdrop.embedUrl && hostLinks.mixdrop.embedUrl !== 'MEGA' && hostLinks.mixdrop.embedUrl.includes('/e/')) {
            embedLink = hostLinks.mixdrop.embedUrl;
        } else if (hostLinks.streamtape.embedUrl && hostLinks.streamtape.embedUrl !== 'MEGA' && hostLinks.streamtape.embedUrl.includes('/e/')) {
            embedLink = hostLinks.streamtape.embedUrl;
        } else if (hostLinks.other.embedUrl && hostLinks.other.embedUrl !== 'MEGA' && hostLinks.other.embedUrl.startsWith('http')) {
            embedLink = hostLinks.other.embedUrl;
        } else if (hostLinks.mega.embedUrl === 'MEGA') {
            isMega = true;
            embedLink = null;
        } else {
            // No embeddable link found
            videoWrap.innerHTML = "<h3 style='color:white;text-align:center;margin-top:20px;'>‚ö†Ô∏è No valid video link found for player.</h3>";
        }
        
        // Render the video player or warning
        if (isMega) {
             videoWrap.innerHTML = `<h3 style='color:white;text-align:center;margin-top:40px;'>
                ‚ö†Ô∏è This video is hosted on MEGA. It cannot be embedded here.
            </h3>`;
        } else if (embedLink) {
            videoWrap.innerHTML = `<iframe src="${embedLink}" allowfullscreen allow="autoplay; fullscreen; encrypted-media; picture-in-picture"></iframe>`;
        }
        
        // 4. Render all download/open buttons (Order is by host, not priority)
        
        // Telegram Button (Download)
        if(telegramLink){
            controlsContainer.innerHTML += `<a class="btn btn-telegram" href="${telegramLink}" target="_blank" onclick="openAdsterraPop();">
                ‚¨áÔ∏è Download / Watch on Telegram
            </a>`;
        }

        // MixDrop Button
        if (hostLinks.mixdrop.url) {
            controlsContainer.innerHTML += `<a class="btn btn-mixdrop" href="${hostLinks.mixdrop.url}" target="_blank" onclick="openAdsterraPop();">
                üîó Open MixDrop Link
            </a>`;
        }

        // Streamwish Button
        if (hostLinks.streamwish.url) {
            controlsContainer.innerHTML += `<a class="btn btn-streamwish" href="${hostLinks.streamwish.url}" target="_blank" onclick="openAdsterraPop();">
                üîó Open Streamwish Link
            </a>`;
        }
        
        // Streamtape Button
        if (hostLinks.streamtape.url) {
            controlsContainer.innerHTML += `<a class="btn btn-streamtape" href="${hostLinks.streamtape.url}" target="_blank" onclick="openAdsterraPop();">
                üîó Open Streamtape Link
            </a>`;
        }
        
        // MEGA Button
        if (hostLinks.mega.url) {
            controlsContainer.innerHTML += `<a class="btn btn-mega" href="${hostLinks.mega.url}" target="_blank" onclick="openAdsterraPop();">
                üîó Open MEGA Link
            </a>`;
        }
        
        // Other Button
        if (hostLinks.other.url && !embedLink) {
             controlsContainer.innerHTML += `<a class="btn" href="${hostLinks.other.url}" target="_blank" onclick="openAdsterraPop();">
                üîó Open Video Source
            </a>`;
        }
        
    } else {
        videoWrap.innerHTML = "<h2 style='color:white;text-align:center;'>‚ö†Ô∏è No video link parameter found</h2>";
    }
}

// 4. Initial Load
document.addEventListener('DOMContentLoaded', loadVideo);
</script>
</body>
    </html>
    
