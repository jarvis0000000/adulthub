<script>
// ------------- AD BLOCKER & HELPER LOGIC -------------
function showAdBlockerWarning(){
    isAdBlockerActive = true;
    const warning = document.getElementById('adblock-warning-overlay');
    const content = document.getElementById('main-content-wrapper');
    if (warning) warning.style.display = 'flex';
    if (content) content.style.display = 'none';
}

function showContent(){
    isAdBlockerActive = false;
    const warning = document.getElementById('adblock-warning-overlay');
    const content = document.getElementById('main-content-wrapper');
    if (warning) warning.style.display = 'none';
    if (content) content.style.display = 'flex'; 
}

function checkAdBlocker(){
    return new Promise(resolve => {
        const dummyAd = document.createElement('div');
        dummyAd.className = 'pub_300x250 pub_dummy_ad ads adblock_detected';
        dummyAd.style.width = '1px';
        dummyAd.style.height = '1px';
        dummyAd.style.position = 'absolute';
        dummyAd.style.left = '-1000px';
        document.body.appendChild(dummyAd);
        setTimeout(() => {
            if (dummyAd.offsetHeight === 0 || dummyAd.offsetParent === null || window.getComputedStyle(dummyAd).getPropertyValue('display') === 'none') {
                resolve(true); 
            } else {
                resolve(false); 
            }
            dummyAd.remove();
        }, 300);
    });
}

// üõë FINAL FIX: Determines Embed URL, Label, and Color
function getEmbedDetails(url) {
    url = url.trim();
    const details = { url: url, isEmbed: false, label: 'Open Player', color: '#e91e63' };

    if (!url.startsWith('http')) return details; 

    // --- Specific Link Type Detection ---

    // 1. Telegram Download Link (Highest Priority Button)
    if (url.includes("t.me") || url.includes("telegram.me")) {
        details.isEmbed = false;
        details.label = '‚¨áÔ∏è Download Telegram';
        details.color = '#2aabee'; // Telegram Blue
    }
    // 2. Streamtape (Embeddable & Button Label)
    else if (url.includes("streamtape.com/v/")){
        const m = url.match(/\/v\/([0-9A-Za-z_-]+)\/?/);
        if (m && m[1]) {
            details.url = `https://streamtape.com/e/${m[1]}/`; // Convert to embed URL
            details.isEmbed = true; // Mark as embeddable
            details.label = 'Open Streamtape';
            details.color = '#0088ff';
        }
    } 
    // 3. Streamwish (Embeddable & Button Label)
    else if (url.includes("streamwish.com") || url.includes("sw.fun")) {
        // Assuming the watch link is already the embed link or close to it (streamwish.com/e/hash)
        details.isEmbed = url.includes('/e/'); 
        details.label = 'Open Streamwish';
        details.color = '#ff6347'; // Tomato
    }
    // 4. Mixdrop (Embeddable & Button Label)
    else if (url.includes("mixdrop.co") || url.includes("mixdrop.ag")) {
        // Assuming the watch link is already the embed link or close to it (mixdrop.co/e/hash)
        details.isEmbed = url.includes('/e/'); 
        details.label = 'Open Mixdrop';
        details.color = '#6a0dad'; // Deep Purple
    }
    // 5. MEGA Link (Cannot be embedded - Button Label)
    else if (url.includes("mega.nz")) {
        details.isEmbed = false;
        details.label = 'Open MEGA Link';
        details.color = '#007bff'; // Blue
    }
    // 6. Generic Link (Last Fallback Embed - Used if no specific host is found but it's HTTP/S)
    else if (url.startsWith('http')){
        details.isEmbed = true;
        details.label = 'Open Generic Player';
        details.color = '#e91e63'; // Pink
    }


    // If the link is not embeddable (e.g., Telegram, MEGA), the button should open the raw link.
    // If it is embeddable, the details.url already holds the embed link (for Streamtape) or the raw link (for others).
    return details;
}

// ------------- VIDEO LOAD LOGIC -------------
async function loadVideo(){
    // 1. Check Ad Blocker
    const adBlockActive = await checkAdBlocker();
    if (adBlockActive) {
        showAdBlockerWarning();
        return; 
    }
    showContent();
    
    // 2. Pop-under Ad on successful load
    openAdsterraPop();

    // 3. Video URL Parsing and rendering
    const params = new URLSearchParams(window.location.search);
    let raw = params.get("url");
    const videoWrap = document.getElementById("videoWrap");
    const controlsContainer = document.getElementById("controls-container");
    controlsContainer.innerHTML = ''; // Clear old buttons

    if(raw){
        const fullLinks = decodeURIComponent(raw).split(',').map(l => l.trim()).filter(Boolean);
        
        let primaryEmbedUrl = '';
        let primaryEmbedLabel = '';
        const buttonsHtml = [];
        const embeddableLinks = [];

        // Separate embeddable links from button-only links (Telegram/MEGA)
        for(const link of fullLinks) {
            const details = getEmbedDetails(link);
            
            // Collect all embeddable links (Streamwish, Mixdrop, Streamtape, Generic)
            if (details.isEmbed) {
                embeddableLinks.push(details);
            }

            // Create button HTML for ALL links
            buttonsHtml.push(`
                <button class="btn" style="background:${details.color};" 
                        onclick="openAdsterraPop(); window.open('${link}', '_blank')">
                    ${details.label}
                </button>
            `);
        }
        
        // Use the first embeddable link found as the main player
        if (embeddableLinks.length > 0) {
            const primaryDetails = embeddableLinks[0];
            primaryEmbedUrl = primaryDetails.url; 
            primaryEmbedLabel = primaryDetails.label; 
        }

        // 4. Embed the Primary Video
        if (primaryEmbedUrl) {
            videoWrap.innerHTML = `<iframe src="${primaryEmbedUrl}" allowfullscreen allow="autoplay; fullscreen; encrypted-media; picture-in-picture"></iframe>`;
            // Update user message to indicate which player is loaded
            document.getElementById('user-message').innerHTML = `üéâ **Enjoy watching!** Video loaded from **${primaryEmbedLabel.replace('Open ', '').replace(' Player', '')}**.`;
        } else {
            videoWrap.innerHTML = "<h3 style='color:white;text-align:center;margin-top:20px;'>‚ö†Ô∏è No valid embeddable video link found. Use the buttons below to watch.</h3>";
        }

        // 5. Render Buttons (All buttons, including Telegram/MEGA)
        controlsContainer.innerHTML = buttonsHtml.join('');
        
    } else {
        videoWrap.innerHTML = "<h2 style='color:white;text-align:center;'>‚ö†Ô∏è No video link parameter found</h2>";
    }
}

// 4. Initial Load
document.addEventListener('DOMContentLoaded', loadVideo);
            </script>
            
